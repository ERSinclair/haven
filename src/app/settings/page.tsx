'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { deleteMyAccount } from '@/lib/account-deletion';

export default function SettingsPage() {
  const [userData, setUserData] = useState<any>(null);
  const [settings, setSettings] = useState({
    notifications: {
      messages: true,
      nearbyFamilies: true,
      events: true,
      digest: false,
    },
    privacy: {
      showDistance: true,
      showKidsAges: true,
      allowMessages: true,
      locationPrecision: 'suburb', // 'suburb' | 'approximate' | 'hidden'
    },
  });
  const [showLogout, setShowLogout] = useState(false);
  const [showDelete, setShowDelete] = useState(false);
  const [deleteLoading, setDeleteLoading] = useState(false);
  const router = useRouter();

  useEffect(() => {
    const saved = localStorage.getItem('familyFinderUser');
    if (saved) setUserData(JSON.parse(saved));
    
    const savedSettings = localStorage.getItem('familyFinderSettings');
    if (savedSettings) setSettings(JSON.parse(savedSettings));
  }, []);

  const updateSetting = (category: 'notifications' | 'privacy', key: string, value: boolean) => {
    const newSettings = {
      ...settings,
      [category]: { ...settings[category], [key]: value }
    };
    setSettings(newSettings);
    localStorage.setItem('familyFinderSettings', JSON.stringify(newSettings));
  };

  const handleLogout = () => {
    localStorage.removeItem('familyFinderUser');
    localStorage.removeItem('familyFinderSettings');
    sessionStorage.clear();
    router.push('/');
  };

  const handleDelete = async () => {
    if (deleteLoading) return;
    
    setDeleteLoading(true);
    try {
      await deleteMyAccount();
      // deleteMyAccount() already clears localStorage/sessionStorage
      router.push('/');
    } catch (error) {
      console.error('Failed to delete account:', error);
      alert('Failed to delete account. Please try again or contact support.');
      setDeleteLoading(false);
    }
  };

  const Toggle = ({ enabled, onChange }: { enabled: boolean; onChange: () => void }) => (
    <button
      onClick={onChange}
      className={`relative w-11 h-6 rounded-full transition-colors ${enabled ? 'bg-blue-600' : 'bg-gray-200'}`}
    >
      <span className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${enabled ? 'translate-x-5' : ''}`} />
    </button>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-100 sticky top-0 z-10">
        <div className="max-w-md mx-auto px-4 py-5">
          <div className="flex items-center justify-between">
            <h1 className="text-lg font-bold bg-gradient-to-r from-teal-600 via-teal-500 to-emerald-500 bg-clip-text text-transparent" style={{ fontFamily: 'var(--font-fredoka)' }}>
              Haven
            </h1>
            <Link href="/profile" className="text-teal-600 hover:text-teal-700 font-medium">
              ‚Üê Back
            </Link>
          </div>
        </div>
      </div>

      <div className="max-w-md mx-auto px-4 py-6 space-y-6">
        {/* Account */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h2 className="text-sm font-semibold text-gray-600">ACCOUNT</h2>
          </div>
          <Link href="/profile" className="flex items-center p-4 hover:bg-gray-50">
            <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold mr-4">
              {userData?.name?.charAt(0) || '?'}
            </div>
            <div className="flex-1">
              <p className="font-semibold text-gray-900">{userData?.name || 'Guest'}</p>
              <p className="text-sm text-gray-500">{userData?.location || 'No location'}</p>
            </div>
            <span className="text-gray-300">‚Üí</span>
          </Link>
          <Link href="/profile" className="flex items-center justify-between p-4 border-t border-gray-100 hover:bg-gray-50">
            <span className="text-gray-700">Edit profile</span>
            <span className="text-gray-300">‚Üí</span>
          </Link>
        </div>

        {/* Notifications */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h2 className="text-sm font-semibold text-gray-600">NOTIFICATIONS</h2>
          </div>
          
          <div className="divide-y divide-gray-100">
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">New messages</p>
                <p className="text-sm text-gray-500">When families message you</p>
              </div>
              <Toggle 
                enabled={settings.notifications.messages} 
                onChange={() => updateSetting('notifications', 'messages', !settings.notifications.messages)}
              />
            </div>
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Nearby families</p>
                <p className="text-sm text-gray-500">New families in your area</p>
              </div>
              <Toggle 
                enabled={settings.notifications.nearbyFamilies}
                onChange={() => updateSetting('notifications', 'nearbyFamilies', !settings.notifications.nearbyFamilies)}
              />
            </div>
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Events</p>
                <p className="text-sm text-gray-500">Reminders and updates</p>
              </div>
              <Toggle 
                enabled={settings.notifications.events}
                onChange={() => updateSetting('notifications', 'events', !settings.notifications.events)}
              />
            </div>
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Weekly digest</p>
                <p className="text-sm text-gray-500">Summary of activity</p>
              </div>
              <Toggle 
                enabled={settings.notifications.digest}
                onChange={() => updateSetting('notifications', 'digest', !settings.notifications.digest)}
              />
            </div>
          </div>
        </div>

        {/* Privacy */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h2 className="text-sm font-semibold text-gray-600">PRIVACY</h2>
          </div>
          
          <div className="divide-y divide-gray-100">
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Show distance</p>
                <p className="text-sm text-gray-500">Others see how far you are</p>
              </div>
              <Toggle 
                enabled={settings.privacy.showDistance}
                onChange={() => updateSetting('privacy', 'showDistance', !settings.privacy.showDistance)}
              />
            </div>
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Show kids' ages</p>
                <p className="text-sm text-gray-500">Display ages on profile</p>
              </div>
              <Toggle 
                enabled={settings.privacy.showKidsAges}
                onChange={() => updateSetting('privacy', 'showKidsAges', !settings.privacy.showKidsAges)}
              />
            </div>
            <div className="flex items-center justify-between p-4">
              <div>
                <p className="font-medium text-gray-900">Allow messages</p>
                <p className="text-sm text-gray-500">Let families contact you</p>
              </div>
              <Toggle 
                enabled={settings.privacy.allowMessages}
                onChange={() => updateSetting('privacy', 'allowMessages', !settings.privacy.allowMessages)}
              />
            </div>
          </div>
        </div>

        {/* Location Privacy */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h2 className="text-sm font-semibold text-gray-600">üìç LOCATION</h2>
          </div>
          
          <div className="p-4">
            <p className="text-sm text-gray-600 mb-4">
              Control how your location appears on the map and to other families.
            </p>
            
            <div className="space-y-2">
              {[
                { 
                  value: 'suburb', 
                  label: 'Suburb only', 
                  desc: 'Show your suburb name (e.g. "Torquay")',
                  recommended: true 
                },
                { 
                  value: 'approximate', 
                  label: 'Approximate distance', 
                  desc: 'Show "~5km away" but not on map' 
                },
                { 
                  value: 'hidden', 
                  label: 'Hidden', 
                  desc: 'Don\'t show location at all' 
                },
              ].map((option) => (
                <label 
                  key={option.value}
                  className={`flex items-center p-3 rounded-xl border-2 cursor-pointer transition-all ${
                    settings.privacy.locationPrecision === option.value
                      ? 'border-blue-600 bg-blue-50'
                      : 'border-gray-100 hover:border-gray-200'
                  }`}
                >
                  <input
                    type="radio"
                    name="locationPrecision"
                    className="sr-only"
                    checked={settings.privacy.locationPrecision === option.value}
                    onChange={() => {
                      const newSettings = {
                        ...settings,
                        privacy: { ...settings.privacy, locationPrecision: option.value }
                      };
                      setSettings(newSettings);
                      localStorage.setItem('familyFinderSettings', JSON.stringify(newSettings));
                    }}
                  />
                  <div className="flex-1">
                    <p className={`font-medium ${settings.privacy.locationPrecision === option.value ? 'text-blue-700' : 'text-gray-900'}`}>
                      {option.label}
                      {option.recommended && (
                        <span className="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                          Recommended
                        </span>
                      )}
                    </p>
                    <p className="text-sm text-gray-500">{option.desc}</p>
                  </div>
                  <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                    settings.privacy.locationPrecision === option.value
                      ? 'border-blue-600 bg-blue-600'
                      : 'border-gray-300'
                  }`}>
                    {settings.privacy.locationPrecision === option.value && (
                      <div className="w-2 h-2 bg-white rounded-full"></div>
                    )}
                  </div>
                </label>
              ))}
            </div>

            <div className="mt-4 p-3 bg-blue-50 rounded-xl">
              <p className="text-xs text-blue-700">
                <strong>Note:</strong> Your exact address is never shared. Map pins are always randomised within your suburb area.
              </p>
            </div>
          </div>
        </div>

        {/* Support */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h2 className="text-sm font-semibold text-gray-600">SUPPORT</h2>
          </div>
          
          <div className="divide-y divide-gray-100">
            {[
              { label: 'Help Center', icon: '‚ùì' },
              { label: 'Contact Support', icon: 'üí¨' },
              { label: 'Community Guidelines', icon: 'üìã' },
              { label: 'Privacy Policy', icon: 'üîí' },
            ].map((item) => (
              <button key={item.label} className="flex items-center w-full p-4 hover:bg-gray-50 text-left">
                <span className="mr-3">{item.icon}</span>
                <span className="flex-1 text-gray-700">{item.label}</span>
                <span className="text-gray-300">‚Üí</span>
              </button>
            ))}
          </div>
        </div>

        {/* Danger Zone */}
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div className="divide-y divide-gray-100">
            <button 
              onClick={() => setShowLogout(true)}
              className="flex items-center w-full p-4 hover:bg-gray-50 text-left"
            >
              <span className="text-gray-700">Log out</span>
            </button>
            <button 
              onClick={() => setShowDelete(true)}
              className="flex items-center w-full p-4 hover:bg-red-50 text-left"
            >
              <span className="text-red-600">Delete account</span>
            </button>
          </div>
        </div>

        {/* Version */}
        <p className="text-center text-xs text-gray-400 py-4">
          <span style={{ fontFamily: 'var(--font-fredoka)' }} className="text-teal-500 font-medium">Haven</span> v0.1.0 ¬∑ Made in Australia üá¶üá∫
        </p>
      </div>

      {/* Logout Modal */}
      {showLogout && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-sm w-full p-6 animate-slideUp">
            <h3 className="text-xl font-bold text-gray-900 mb-2">Log out?</h3>
            <p className="text-gray-600 mb-6">You'll need to sign in again to access your profile.</p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowLogout(false)}
                className="flex-1 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200"
              >
                Cancel
              </button>
              <button
                onClick={handleLogout}
                className="flex-1 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700"
              >
                Log out
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Modal */}
      {showDelete && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-sm w-full p-6 animate-slideUp">
            <h3 className="text-xl font-bold text-red-600 mb-2">Delete account?</h3>
            <p className="text-gray-600 mb-4">This will permanently delete your profile, messages, and connections.</p>
            <div className="bg-red-50 p-3 rounded-xl mb-6">
              <p className="text-sm text-red-700">‚ö†Ô∏è This cannot be undone</p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDelete(false)}
                className="flex-1 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200"
              >
                Cancel
              </button>
              <button
                onClick={handleDelete}
                disabled={deleteLoading}
                className="flex-1 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                {deleteLoading ? 'Deleting...' : 'Delete'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
